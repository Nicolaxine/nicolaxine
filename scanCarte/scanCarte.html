<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0c11">
  <link rel="shortcut icon" href="http://freenicox.free.fr/Nicolaxine/faviconBoite.ico" title="Nicolaxine" />
  <link rel="icon" type="image/gif" href="http://freenicox.free.fr/Nicolaxine/faviconBoite.gif" />
  <title>NICOLAXINE ‚Äî LECTEUR DE BADGE</title>

  <style>
    :root {
      --fond: #0a0c11;
      --panneau: #141821;
      --vert-heegrek: #40e070;
      --vert-fonce-heegrek: #2e7d32;
      --jaune-hiksse: #f4c430;
      --jaune-fonce-hiksse: #c29e26;
      --glow-green: rgba(64, 224, 112, 0.6);
      --glow-yellow: rgba(244, 196, 48, 0.6);
      --texte: #e8f5e9;
      --cadre: rgba(64, 224, 112, 0.4);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      height: 100dvh;
      background: var(--fond);
      color: var(--texte);
      font-family: monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 60px;
      background: var(--panneau);
      border-bottom: 1px solid var(--vert-heegrek);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      letter-spacing: 2px;
      color: var(--vert-heegrek);
      text-shadow: 0 0 10px var(--glow-green);
      flex-shrink: 0;
    }

    .container {
      flex: 1;
      position: relative;
    }

    #video, #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #overlay { pointer-events: none; }

    /* CADRE FIXE VISIBLE AU CENTRE */
    #cadre-scan {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 360px;
      height: 220px;
      border: 3px dashed var(--cadre);
      border-radius: 12px;
      box-shadow: 0 0 20px var(--glow-green);
      pointer-events: none;
      z-index: 5;
    }

    #cadre-label {
      position: absolute;
      top: -34px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,26,15,0.8);
      color: var(--vert-heegrek);
      padding: 4px 14px;
      border-radius: 6px;
      font-size: 1rem;
      white-space: nowrap;
      pointer-events: none;
    }

    #scan-bar {
      position: absolute;
      width: 100%;
      height: 4px;
      background: linear-gradient(to right, transparent, var(--vert-heegrek), transparent);
      box-shadow: 0 0 15px var(--glow-green);
      animation: scan-down 6s linear infinite;
      pointer-events: none;
    }

    @keyframes scan-down {
      0% { top: -10px; }
      100% { top: 100%; }
    }

    #info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,26,15,0.88);
      border: 1px solid var(--vert-heegrek);
      border-radius: 8px;
      padding: 14px 28px;
      font-size: 1.4rem;
      color: var(--vert-heegrek);
      text-shadow: 0 0 10px var(--glow-green);
      text-align: center;
      min-width: 340px;
      z-index: 10;
    }

    #overlay-message {
      position: fixed;
      inset: 0;
      background: rgba(10,12,17,0.96);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 3rem;
      font-weight: 600;
      text-align: center;
      padding: 40px;
    }

    #overlay-message.visible {
      display: flex;
    }

    #overlay-message.heegrek { color: var(--vert-heegrek); text-shadow: 0 0 20px var(--glow-green); }
    #overlay-message.hiksse { color: var(--jaune-hiksse); text-shadow: 0 0 20px var(--glow-yellow); }
	
		.footer-back-btn {
	width: 40px;
	height: 40px;
	padding: 0;
	margin: 0;
	font-size: 1.4rem;
	line-height: 1;
	align-items: center;
	justify-content: center;
	background: #1f2430;
	color: var(--text);
	border: none;
	border-radius: 6px;
	cursor: pointer;
	transition: all 0.2s;
	min-width: unset;
}

.footer-back-btn:hover {
	background: #2a3242;
}
	
		#btn-fullscreen {
	width: 40px;
	height: 40px;
	padding: 0;
	margin: 0;
	font-size: 1.4rem;
	align-items: center;
	justify-content: center;
	background: #1f2430;
	color: var(--text);
	border: none;
	border-radius: 6px;
	cursor: pointer;
	transition: all 0.2s;
	min-width: unset;
	}

	#btn-fullscreen:hover {
	background: #2a3242;
	}

	#btn-fullscreen:disabled {
	opacity: 0.4;
	cursor: not-allowed;
	}

	#btn-refresh {
	width: 40px;
	height: 40px;
	padding: 0;
	margin: 0;
	font-size: 1.4rem;
	line-height: 1;
	align-items: center;
	justify-content: center;
	background: #1f2430;
	color: var(--text);
	border: none;
	border-radius: 6px;
	cursor: pointer;
	transition: all 0.2s;
	min-width: unset;
	}

	#btn-refresh:hover {
	background: #2a3242;
	}

	#btn-refresh:disabled {
	opacity: 0.4;
	cursor: not-allowed;
	}

  </style>
</head>
<body>

  <header>
  <button id="btn-fullscreen">üíª</button>NICOLAXINE ‚Äî LECTEUR DE BADGE
  <button id="btn-refresh" onclick="window.location.href = window.location.pathname + '?refresh=' + Date.now()">üñ≤Ô∏è</button>
  <button class="footer-back-btn" id="btn-retour-footer">‚Ü©Ô∏è</button>
  </header>

  <div class="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>

    <!-- CADRE FIXE VISIBLE AU CENTRE -->
    <div id="cadre-scan">
      <div id="cadre-label">PLACEZ VOTRE BADGE ICI</div>
    </div>

    <div id="scan-bar"></div>
    <div id="info">PR√âSENTEZ VOTRE BADGE DEVANT LA CAM√âRA</div>
    <div id="overlay-message">ACC√àS AUTORIS√â</div>
  </div>

<script>
  const video = document.getElementById('video');
  const info = document.getElementById('info');
  const overlayMsg = document.getElementById('overlay-message');

  let stableCount = 0;
  const STABLE_THRESHOLD = 20; // ~3 secondes √† 150ms/frame
  const QR_THRESHOLD = 0.50; // seuil plus haut pour √©viter faux positifs

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(stream => video.srcObject = stream)
    .catch(err => info.textContent = "Cam√©ra refus√©e : " + err.message);

  video.addEventListener('play', () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext('2d');

    setInterval(() => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Zone centrale petite
      const sampleSize = 120;
      const centerX = Math.floor(canvas.width / 2);
      const centerY = Math.floor(canvas.height / 2);
      const roi = ctx.getImageData(centerX - sampleSize/2, centerY - sampleSize/2, sampleSize, sampleSize);

      let darkPixels = 0;
      let lightPixels = 0;
      let greenScore = 0;
      let yellowScore = 0;
      const data = roi.data;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i+1];
        const b = data[i+2];
        const brightness = (r + g + b) / 3;

        if (brightness < 80) darkPixels++;
        if (brightness > 170) lightPixels++;

        // Vert Heegrek
        if (g > 110 && g > r + 25 && g > b + 25) greenScore++;
        // Jaune Hiksse
        if (r > 140 && g > 120 && Math.abs(r - g) < 80 && b < 120) yellowScore++;
      }

      const total = sampleSize * sampleSize;
      const qrScore = (darkPixels + lightPixels) / total;
      const greenPct = greenScore / total;
      const yellowPct = yellowScore / total;

      // Affichage live du score pour debug
      info.textContent = "SCAN …õ " + qrScore.toFixed(2) + " | œÜ " + greenPct.toFixed(2) + " | œÄ " + yellowPct.toFixed(2);

      console.log("…õ:", qrScore.toFixed(2), "œÜ:", greenPct.toFixed(2), "œÄ:", yellowPct.toFixed(2));

      if (qrScore > QR_THRESHOLD) {
        stableCount++;

        if (stableCount >= STABLE_THRESHOLD) {
          // Diff√©renciation r√©elle : couleur dominante
          if (greenPct > yellowPct) {
            info.textContent = "BADGE VERT ‚Äî PR. HEEGREK ‚Äî NIVEAU 4";
            showAuthorized("PR. HEEGREK ‚Äî ACC√àS NIVEAU 4 CONFIRM√â", 'var(--vert-heegrek)');
          } else {
            info.textContent = "BADGE JAUNE ‚Äî DR. HIKSSE ‚Äî NIVEAU 3";
            showAuthorized("DR. HIKSSE ‚Äî ACC√àS NIVEAU 3 CONFIRM√â", 'var(--jaune-hiksse)');
          }
          stableCount = 0;
        }
      } else {
        stableCount = 0;
      }
    }, 150);
  });

  function showAuthorized(message, color) {
    overlayMsg.textContent = message;
    overlayMsg.style.color = color;
    overlayMsg.classList.add('visible');

    const audio = new AudioContext();
    const osc = audio.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(1200, audio.currentTime);
    osc.frequency.linearRampToValueAtTime(800, audio.currentTime + 0.3);
    const gain = audio.createGain();
    osc.connect(gain);
    gain.connect(audio.destination);
    gain.gain.setValueAtTime(0.25, audio.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.6);
    osc.start();
    osc.stop(audio.currentTime + 0.6);

    setTimeout(() => {
      overlayMsg.classList.remove('visible');
      setTimeout(() => {
        window.location.href = "http://freenicox.free.fr/Nicolaxine/ApplicationNicolaxine/Carte_Portail_Tri-DimensionnelOK.html";
      }, 1500);
    }, 3000);
  }
  
  
		document.getElementById('btn-fullscreen').onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
		};
		
				  document.getElementById('btn-retour-footer').onclick = () => {
  // Option 1 : Retour historique (comme le bouton back du navigateur)
			history.back();
</script>
</body>
</html>